name: 构建和发布

on:
  push:
    branches: [main]

jobs:
  detect:
    if: ${{ github.event.head_commit && contains(github.event.head_commit.message, '[pub]') }}
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Filter changed packages
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            core:
              - 'packages/core/**'
            model:
              - 'packages/model/**'
            plugin:
              - 'packages/plugin/**'
            request:
              - 'packages/request/**'
            ui:
              - 'packages/ui/**'
            utils:
              - 'packages/utils/**'
            vite:
              - 'packages/vite/**'
            db:
              - 'packages/db/**'

      - name: Build matrix JSON
        id: set-matrix
        env:
          IS_FORCE: ${{ contains(github.event.head_commit.message, '[f]') }}
          CORE: ${{ steps.filter.outputs.core }}
          MODEL: ${{ steps.filter.outputs.model }}
          PLUGIN: ${{ steps.filter.outputs.plugin }}
          REQUEST: ${{ steps.filter.outputs.request }}
          UI: ${{ steps.filter.outputs.ui }}
          UTILS: ${{ steps.filter.outputs.utils }}
          VITE: ${{ steps.filter.outputs.vite }}
          DB: ${{ steps.filter.outputs.db }}
        run: |
          node -e '
          const map = [
            ["core","packages/core"],
            ["model","packages/model"],
            ["plugin","packages/plugin"],
            ["request","packages/request"],
            ["ui","packages/ui"],
            ["utils","packages/utils"],
            ["vite","packages/vite"],
            ["db","packages/db"]
          ];
          const out = [];
          if (process.env.IS_FORCE) {
            const json = JSON.stringify(map.map(v => ({ name: v[0], path: v[1] })));
            require("fs").writeFileSync(process.env.GITHUB_OUTPUT, `matrix=${json}\n`);
            console.log("matrix:", json);
            process.exit(0);
          }
          for (const [name, path] of map) {
            const flag = process.env[name.toUpperCase()] === "true";
            if (flag) out.push({ name, path });
          }
          const json = JSON.stringify(out);
          require("fs").writeFileSync(process.env.GITHUB_OUTPUT, `matrix=${json}\n`);
          console.log("matrix:", json);
          '
  release:
    needs: detect
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include: ${{ fromJson(needs.detect.outputs.matrix) }}

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Configure git author
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4.2.0
        with:
          version: 10.27.0

      - name: Node setup
        uses: actions/setup-node@v6.2.0
        with:
          node-version: 24
          cache: pnpm

      - name: Install deps
        run: |
          pnpm --filter utils i
          pnpm --filter ${{ matrix.name }} i

      - name: Build
        run: |
          pnpm --filter utils build
          pnpm --filter ${{ matrix.name }} build

      - name: Run semantic-release for package
        working-directory: ${{ matrix.path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pnpm exec semantic-release --config "${{ github.workspace }}/release.config.js"
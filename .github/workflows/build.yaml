name: Build & Publish

on:
  push:
    branches: [main]

permissions:
  contents: write
  id-token: write

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Filter changed packages
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            core:
              - 'packages/core/**'
            model:
              - 'packages/model/**'
            plugin:
              - 'packages/plugin/**'
            request:
              - 'packages/request/**'
            ui:
              - 'packages/ui/**'
            utils:
              - 'packages/utils/**'
            vite:
              - 'packages/vite/**'
            db:
              - 'packages/db/**'

      - name: Build matrix JSON
        id: set-matrix
        env:
          IS_FORCE: ${{ contains(github.event.head_commit.message, '[f]') }}
          CORE: ${{ steps.filter.outputs.core }}
          MODEL: ${{ steps.filter.outputs.model }}
          PLUGIN: ${{ steps.filter.outputs.plugin }}
          REQUEST: ${{ steps.filter.outputs.request }}
          UI: ${{ steps.filter.outputs.ui }}
          UTILS: ${{ steps.filter.outputs.utils }}
          VITE: ${{ steps.filter.outputs.vite }}
          DB: ${{ steps.filter.outputs.db }}
        run: |
          node -e '
          const map = [
            ["core","packages/core"],
            ["model","packages/model"],
            ["plugin","packages/plugin"],
            ["request","packages/request"],
            ["ui","packages/ui"],
            ["utils","packages/utils"],
            ["vite","packages/vite"],
            ["db","packages/db"]
          ];
          const out = [];
          if (process.env.IS_FORCE) {
            const json = JSON.stringify(map.map(v => ({ name: v[0], path: v[1] })));
            require("fs").writeFileSync(process.env.GITHUB_OUTPUT, `matrix=${json}\n`);
            console.log("matrix:", json);
            process.exit(0);
          }
          for (const [name, path] of map) {
            const flag = process.env[name.toUpperCase()] === "true";
            if (flag) out.push({ name, path });
          }
          const json = JSON.stringify(out);
          require("fs").writeFileSync(process.env.GITHUB_OUTPUT, `matrix=${json}\n`);
          console.log("matrix:", json);
          '

  build-workspace:
    needs: detect
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup pnpm & node
        uses: pnpm/action-setup@v4.2.0
        with:
          version: 10.27.0
      - uses: actions/setup-node@v6.2.0
        with:
          node-version: 24
          cache: pnpm

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Build changed packages and their local deps only
        # 读取 needs.detect.outputs.matrix（它是 JSON 数组），拼接出 pnpm 的 filter 参数
        run: |
          echo "matrix json: ${{ needs.detect.outputs.matrix }}"
          node -e '
          const m = JSON.parse(process.env.MATRIX_JSON || "[]");
          if (m.length === 0) {
            console.log("No changed packages detected — building whole workspace as fallback");
            require("child_process").execSync("pnpm -w -r --parallel build", { stdio: "inherit" });
            process.exit(0);
          }
          // 生成 filter 形式：--filter ./packages/core...  并加上 --recursive 以构建依赖
          const filters = m.map(p => `--filter=${p.path}`).join(" ");
          const cmd = `pnpm -w -r --parallel ${filters} build`;
          console.log("Running:", cmd);
          require("child_process").execSync(cmd, { stdio: "inherit" });
          '
        env:
          MATRIX_JSON: ${{ needs.detect.outputs.matrix }}

      - name: Upload built packages artifact
        uses: actions/upload-artifact@v4
        with:
          name: built-packages
          path: packages

  release:
    needs:
      - detect
      - build-workspace
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include: ${{ fromJson(needs.detect.outputs.matrix) }}

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Configure git author
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4.2.0
        with:
          version: 10.27.0

      - name: Node setup
        uses: actions/setup-node@v6.2.0
        with:
          node-version: 24
          cache: pnpm

      - name: Install deps
        run: |
          pnpm --filter ${{ matrix.name }} i

      - name: Build
        run: |
          pnpm --filter ${{ matrix.name }} build

      - name: Run semantic-release for package
        working-directory: ${{ matrix.path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pnpm exec semantic-release --config "${{ github.workspace }}/release.config.js"